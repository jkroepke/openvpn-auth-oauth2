version: '3'
services:
  openvpn:
    # noinspection ComposeUnknownKeys
    init: true
    image: local/openvpn
    build:
      dockerfile: Dockerfile
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun
    ports:
      - "1194:1194/tcp"
      - "1194:1194/udp"
      - "8081:8081/tcp"
    volumes:
      - ./:/tests/:ro
      - ./data:/etc/openvpn
      - ./../pkg/plugin:/plugin/
    restart: always
    environment:
      EASYRSA: /usr/share/easy-rsa/
      EASYRSA_PKI: /etc/openvpn/pki
      EASYRSA_BATCH: 1
      EASYRSA_NO_VARS: 1
      EASYRSA_NO_PASS: 1
      EASYRSA_ALGO: "ed"
      EASYRSA_CURVE: "ed25519"
      EASYRSA_DN: "cn_only"
      UPN: "${UPN}"
    entrypoint:
      - /bin/sh
      - -ec
      - |-
        if [ ! -f /etc/openvpn/pki/ca.crt ]; then
          /usr/share/easy-rsa/easyrsa init-pki nopass
          /usr/share/easy-rsa/easyrsa build-ca nopass
          /usr/share/easy-rsa/easyrsa build-server-full server nopass
          /usr/share/easy-rsa/easyrsa build-client-full ${UPN} nopass
        fi

        if [ ! -f /etc/openvpn/password.txt ]; then
          printf password > /etc/openvpn/password.txt
        fi

        cat > "/etc/openvpn/openvpn.conf" <<EOF
        dev tun0
        server 100.64.0.0 255.255.255.0
        verb 4
        ca /etc/openvpn/pki/ca.crt
        key /etc/openvpn/pki/private/server.key
        cert /etc/openvpn/pki/issued/server.crt
        dh none
        keepalive 10 60
        persist-key
        persist-tun
        explicit-exit-notify

        #verify-client-cert none
        #username-as-common-name

        tls-cert-profile preferred

        topology subnet
        proto udp
        port 1194

        fast-io
        user nobody
        group nogroup

        # Does not work in containers
        disable-dco
        duplicate-cn

        management 0.0.0.0 8081 /etc/openvpn/password.txt
        management-hold
        management-client-auth

        #plugin /plugin/openvpn-auth-oauth2.so /plugin/config.yaml

        reneg-sec 60
        hand-window 15
        auth-gen-token 300 external-auth
        auth-user-pass-optional

        EOF

        cat > "/etc/openvpn/${UPN}.ovpn" <<EOF
        client
        dev tun
        nobind
        remote 127.0.0.1 1194 udp4
        remote-cert-tls server
        resolv-retry infinite
        tls-cert-profile preferred
        persist-tun
        verb 9
        reneg-sec 0
        <key>
        $(cat /etc/openvpn/pki/private/${UPN}.key)
        </key>
        <cert>
        $(openssl x509 -in /etc/openvpn/pki/issued/${UPN}.crt)
        </cert>
        <ca>
        $(cat /etc/openvpn/pki/ca.crt)
        </ca>
        EOF

        exec openvpn --config "/etc/openvpn/openvpn.conf"
